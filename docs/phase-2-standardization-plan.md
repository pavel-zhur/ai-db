# Phase 2 Standardization Plan

This document provides the comprehensive plan for standardizing the AI-DB system codebase to create a unified, professional, and maintainable project.

## Overview

The current state consists of 5 independently developed components that need to be transformed into a cohesive system. This plan addresses both structural standardization and technical integration to achieve a truly holistic codebase.

## Guiding Principles

1. **Consistency Over Perfection**: Choose one approach and apply it everywhere
2. **Minimal Viable Infrastructure**: Remove redundancy, keep only what's necessary
3. **Developer First**: Optimize for ease of development and contribution
4. **Production Patterns**: Use industry-standard practices even for POC

## Part 1: Repository Structure

### Current State Analysis

Currently we have:
- 5 separate component directories with inconsistent structures
- Mixed approaches to testing (some have tests/, some have test/)
- Inconsistent documentation (some detailed, some minimal)
- Different Python packaging approaches (setup.py vs pyproject.toml)
- Varying Docker strategies (some have Dockerfiles, some don't)
- No shared code or standardized interfaces

### Target Monorepo Structure

```
ai-db-system/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ ci.yml               # CI workflow for entire system âœ…
â”‚       â””â”€â”€ publish.yml          # PyPI publishing workflow âœ…
â”œâ”€â”€ ai-db/                       # Independent library âœ…
â”‚   â”œâ”€â”€ src/ âœ…
â”‚   â”œâ”€â”€ tests/ âœ…
â”‚   â”œâ”€â”€ Dockerfile âœ…
â”‚   â””â”€â”€ pyproject.toml âœ…
â”œâ”€â”€ ai-frontend/                 # Independent library âœ…
â”‚   â”œâ”€â”€ src/ âœ…
â”‚   â”œâ”€â”€ tests/ âœ…
â”‚   â”œâ”€â”€ Dockerfile âœ…
â”‚   â””â”€â”€ pyproject.toml âœ…
â”œâ”€â”€ git-layer/                   # Independent library âœ…
â”‚   â”œâ”€â”€ src/ âœ…
â”‚   â”œâ”€â”€ tests/ âœ…
â”‚   â”œâ”€â”€ Dockerfile âœ…
â”‚   â””â”€â”€ pyproject.toml âœ…
â”œâ”€â”€ console/                     # Independent application âœ…
â”‚   â”œâ”€â”€ src/ âœ…
â”‚   â”œâ”€â”€ tests/ âœ…
â”‚   â”œâ”€â”€ Dockerfile âœ…
â”‚   â””â”€â”€ pyproject.toml âœ…
â”œâ”€â”€ mcp/                        # Independent application âœ…
â”‚   â”œâ”€â”€ src/ âœ…
â”‚   â”œâ”€â”€ tests/ âœ…
â”‚   â”œâ”€â”€ Dockerfile âœ…
â”‚   â””â”€â”€ pyproject.toml âœ…
â”œâ”€â”€ ai-hub/                     # Independent application âœ…
â”‚   â”œâ”€â”€ src/ âœ…
â”‚   â”œâ”€â”€ tests/ âœ…
â”‚   â”œâ”€â”€ Dockerfile âœ…
â”‚   â””â”€â”€ pyproject.toml âœ…
â”œâ”€â”€ shared/                     # Published as ai-db-shared package (Note: Currently named ai-shared)
â”‚   â”œâ”€â”€ src/ âœ…
â”‚   â”œâ”€â”€ tests/ âœ…
â”‚   â””â”€â”€ pyproject.toml âœ…
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ integration/            # Cross-component integration tests âœ…
â”œâ”€â”€ docker-compose.yml          # Full system deployment âœ…
â”œâ”€â”€ azure-pipelines.yml         # Azure DevOps pipeline âœ…
â”œâ”€â”€ Makefile                    # Essential commands only âœ…
â”œâ”€â”€ pyproject.toml             # Workspace-level configuration âœ…
â””â”€â”€ README.md                  # Getting started guide âœ…
```

### Component Structure Standard

Each component follows this structure:

```
{component-name}/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ {name}/                 # Package name (underscores)
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ __version__.py      # Single source of version
â”‚       â”œâ”€â”€ config.py           # Pydantic settings
â”‚       â””â”€â”€ py.typed            # Type checking marker
â”œâ”€â”€ tests/                      # Component tests
â”‚   â””â”€â”€ test_*.py              # Test files
â”œâ”€â”€ Dockerfile                  # Component-specific image
â”œâ”€â”€ README.md                  # Component documentation
â””â”€â”€ pyproject.toml             # Full package metadata for PyPI
```

## Part 2: Python Standardization

### Single Python Version
- **Python 3.13** for all components (latest stable) âœ…

### Workspace Configuration

Each component has its own `pyproject.toml` for independent publishing. The root workspace configuration is minimal:

```toml
# Root pyproject.toml - workspace configuration only âœ…
[tool.black] âœ…
line-length = 100 âœ…
target-version = ["py313"] âœ…

[tool.ruff] âœ…
line-length = 100 âœ…
target-version = "py313" âœ…
select = ["E", "F", "I", "N", "W"]  # Essential rules only âœ…

[tool.mypy] âœ…
python_version = "3.13" âœ…
strict = true âœ…

[tool.pytest.ini_options] âœ…
testpaths = ["tests"] âœ…
asyncio_mode = "auto" âœ…
```

### Component pyproject.toml Template âœ…

Each component has a complete `pyproject.toml` for PyPI publishing:

```toml
[build-system] âœ…
requires = ["poetry-core>=1.0.0"] âœ…
build-backend = "poetry.core.masonry.api" âœ…

[tool.poetry] âœ…
name = "ai-db"  # or ai-frontend, git-layer, etc. âœ…
version = "0.1.0" âœ…
description = "AI-native database engine" âœ…
authors = ["AI-DB Team"] âœ…
license = "MIT" âœ…
readme = "README.md" âœ…
repository = "https://github.com/pavel-zhur/ai-db" âœ…
packages = [{include = "ai_db", from = "src"}] âœ…

[tool.poetry.dependencies] âœ…
python = "^3.13" âœ…
ai-shared = "^0.1.0"  # For interfaces (except in ai-shared itself) âœ… (using path deps)
# Component-specific dependencies âœ…

[tool.poetry.group.dev.dependencies] âœ…
pytest = "^8.0" âœ… (^8.4)
pytest-asyncio = "^0.23" âœ… (^0.24)
mypy = "^1.8" âœ… (^1.16)
ruff = "^0.1" âœ… (^0.12)
black = "^24.1" âœ… (^25.1)
```

## Part 3: Testing Standardization âœ…

### Test Organization âœ…

1. **Component Tests** (`{component}/tests/`) âœ…
   - Unit and integration tests together âœ…
   - Mock external dependencies âœ…
   - Test component in isolation âœ…

2. **Integration Tests** (`tests/integration/`) âœ…
   - Cross-component interactions only âœ…
   - Use testcontainers for external services
   - Test actual integration points âœ…

### Shared Package Content

The `ai-shared` package contains only interface definitions:
```python
# ai-shared/src/ai_shared/protocols.py âœ…
from typing import Protocol
from pathlib import Path

class TransactionProtocol(Protocol):
    """Interface that git-layer implements"""
    @property
    def id(self) -> str: ... âœ…
    @property
    def path(self) -> Path: ... âœ…
    async def write_escalation_required(self) -> None: ... âœ…
    async def operation_complete(self, message: str) -> None: ... âœ…
```

### Test Standards

1. **Simple naming**: `test_{feature}_works` or `test_{feature}_fails_when_{condition}`
2. **Minimal mocking**: Mock only at system boundaries
3. **Async everywhere**: Use pytest-asyncio
4. **Practical coverage**: 80% target

## Part 4: Docker Standardization

### Shared Base Image

Common base image for all Python components:

```dockerfile
# docker/base/Dockerfile âœ…
FROM python:3.13-slim as base âœ…

# Common system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/* âœ…

# Install Poetry
RUN pip install poetry==1.7.1 âœ…

# Python settings
ENV PYTHONUNBUFFERED=1 \
    POETRY_VIRTUALENVS_CREATE=false âœ…

WORKDIR /app âœ…
```

### Component Dockerfiles

Each component builds on the base:

```dockerfile
# Example: ai-db/Dockerfile âœ…
FROM ai-db-system:base âœ…

# Copy only this component
COPY pyproject.toml poetry.lock* ./ âœ… (Note: Using poetry.lock* for optional lock file)
RUN poetry install --no-dev âœ…

COPY src/ ./src/ âœ…

# Component-specific command
CMD ["python", "-m", "ai_db"] âœ…
```

### System Docker Compose

Single `docker-compose.yml` at root for running the complete system:

```yaml
version: '3.8' âœ…

services:
  # Build base image first
  base:
    image: ai-db-system:base âœ…
    build:
      context: .
      dockerfile: docker/base/Dockerfile âœ…
    command: echo "Base image built" âœ…

  ai-hub:
    build: ./ai-hub âœ…
    depends_on:
      - base âœ…
    ports:
      - "8000:8000" âœ…
    environment:
      - AI_DB_API_KEY=${AI_DB_API_KEY} âœ…
    volumes:
      - git-repos:/data/repos âœ…

  console:
    build: ./console
    depends_on:
      - base
    stdin_open: true
    tty: true
    volumes:
      - git-repos:/data/repos

  mcp-ai-db:
    build: ./mcp
    depends_on:
      - base
    command: ["ai-db-mcp"]
    volumes:
      - git-repos:/data/repos

  mcp-ai-frontend:
    build: ./mcp
    depends_on:
      - base
    command: ["ai-frontend-mcp"]
    volumes:
      - git-repos:/data/repos

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - git-repos:/data/repos:ro

volumes:
  git-repos:
```

## Part 5: CI/CD Standardization âœ…

### GitHub Actions Workflow âœ…

Simple, effective CI that tests each component:

```yaml
# .github/workflows/ci.yml âœ…
name: CI âœ…

on: [push, pull_request] âœ…

jobs:
  test:
    runs-on: ubuntu-latest âœ…
    strategy:
      matrix:
        component: [ai-shared, ai-db, ai-frontend, git-layer, console, mcp, ai-hub] âœ…
    
    steps: âœ…
      - uses: actions/checkout@v4 âœ…
      - uses: actions/setup-python@v5 âœ…
        with:
          python-version: '3.13' âœ…
      
      - name: Install Poetry âœ…
        run: pip install poetry âœ…
      
      - name: Test Component âœ…
        working-directory: ./${{ matrix.component }} âœ…
        run: | âœ…
          poetry install âœ…
          poetry run pytest âœ…
          poetry run mypy . âœ…
          poetry run ruff check . âœ…
          poetry run black --check . âœ…
      
  integration:
    runs-on: ubuntu-latest âœ…
    needs: test âœ…
    steps:
      - uses: actions/checkout@v4 âœ…
      - name: Run Integration Tests âœ…
        run: | âœ…
          docker-compose build âœ…
          docker-compose run test-runner âœ… (Note: Changed from 'tests' to 'test-runner')

  publish: âœ…
    if: startsWith(github.ref, 'refs/tags/') âœ…
    needs: [test, integration] âœ…
    runs-on: ubuntu-latest âœ…
    strategy: âœ…
      matrix: âœ…
        component: [ai-shared, ai-db, ai-frontend, git-layer] âœ…
    
    steps: âœ…
      - uses: actions/checkout@v4 âœ…
      - name: Publish to PyPI âœ…
        working-directory: ./${{ matrix.component }} âœ…
        env: âœ…
          POETRY_PYPI_TOKEN_PYPI: ${{ secrets.PYPI_TOKEN }} âœ…
        run: | âœ…
          pip install poetry âœ…
          poetry publish --build âœ…
```

### Azure DevOps Pipeline âœ…

Equivalent pipeline for Azure DevOps:

```yaml
# azure-pipelines.yml âœ…
trigger:
  - main âœ…
  - develop âœ…

pool:
  vmImage: 'ubuntu-latest' âœ…

jobs:
  - job: Test âœ…
    strategy:
      matrix:
        ai-shared:
          component: 'ai-shared' âœ…
        ai-db:
          component: 'ai-db' âœ…
        ai-frontend:
          component: 'ai-frontend' âœ…
        git-layer:
          component: 'git-layer' âœ…
        console:
          component: 'console' âœ…
        mcp:
          component: 'mcp' âœ…
        ai-hub:
          component: 'ai-hub' âœ…
    
    steps:
      - task: UsePythonVersion@0 âœ…
        inputs:
          versionSpec: '3.13' âœ…
      
      - script: pip install poetry âœ…
        displayName: 'Install Poetry' âœ…
      
      - script: |
          cd $(component)
          poetry install
          poetry run pytest
          poetry run mypy .
          poetry run ruff check . âœ…
        displayName: 'Test $(component)' âœ…
  
  - job: Integration
    dependsOn: Test
    steps:
      - script: |
          docker-compose build
          docker-compose run tests
        displayName: 'Integration Tests'
```

## Part 6: Simplified Makefile

Essential commands only:

```makefile
# Root Makefile âœ…
.PHONY: help setup test lint format run clean âœ…

help: ## Show this help âœ…
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}' âœ…

setup: ## Set up development environment âœ…
	@echo "Setting up..." âœ…
	@for dir in ai-shared ai-db ai-frontend git-layer console mcp ai-hub; do \
		(cd $$dir && poetry install); \
	done âœ…

test: ## Run all tests âœ…
	@for dir in ai-shared ai-db ai-frontend git-layer console mcp ai-hub; do \
		echo "Testing $$dir..."; \
		(cd $$dir && poetry run pytest); \
	done âœ…
	@echo "Running integration tests..." âœ…
	@poetry run pytest tests/integration âœ…

lint: ## Run linters âœ…
	@for dir in ai-shared ai-db ai-frontend git-layer console mcp ai-hub; do \
		echo "Linting $$dir..."; \
		(cd $$dir && poetry run ruff check . && poetry run mypy .); \
	done âœ…

format: ## Format code âœ…
	@for dir in ai-shared ai-db ai-frontend git-layer console mcp ai-hub; do \
		(cd $$dir && poetry run black . && poetry run ruff check --fix .); \
	done âœ…

run: ## Run the system âœ…
	docker-compose up âœ…

clean: ## Clean up âœ…
	@find . -type d -name "__pycache__" -exec rm -rf {} + âœ…
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + âœ…
	@docker-compose down -v âœ…
```

## Part 7: Quality Gates âœ…

### Code Quality Checklist
- [âœ…] All components follow standard structure
- [âœ…] No duplicate infrastructure code
- [ ] Consistent error handling patterns
- [âœ…] Shared code properly extracted
- [ ] All interfaces documented

### Testing Checklist
- [ ] 80% code coverage minimum
- [ ] All tests pass locally
- [ ] All tests pass in CI/CD

### Documentation Checklist
- [ ] All READMEs updated and consistent
- [ ] API documentation complete
- [ ] Contributing guide clear

### Developer Experience Checklist
- [ ] Setup takes < 5 minutes
- [ ] All make commands work
- [ ] Docker-compose brings up full system
- [ ] Clear error messages everywhere

## Part 8: Migration Guide âœ…

### For Each Component:

1. **Update Structure**
   ```bash
   # Move to new location
   mv ai-db components/libraries/ai-db
   
   # Restructure to standard layout
   mkdir -p components/libraries/ai-db/src/ai_db
   mv components/libraries/ai-db/*.py components/libraries/ai-db/src/ai_db/
   ```

2. **Update Imports**
   ```python
   # Old
   from transaction import Transaction
   
   # New
   from shared.protocols import TransactionProtocol
   ```

3. **Update Configuration**
   ```python
   # Old
   from typing import Optional
   import os
   
   class Config:
       api_key: Optional[str] = os.getenv("API_KEY")
   
   # New
   from pydantic_settings import BaseSettings
   
   class Config(BaseSettings):
       api_key: str
       
       class Config:
           env_prefix = "AI_DB_"
   ```

4. **Update Tests**
   ```python
   # Old
   from unittest.mock import Mock
   
   # New
   from shared.testing.fixtures import mock_ai_service
   ```

## Success Metrics âœ…

The standardization is complete when:

1. **Structural Consistency** âœ…
   - Single source of configuration âœ…
   - Uniform directory structure âœ…
   - Consistent file naming âœ…

2. **Code Consistency** âœ…
   - Same linting rules pass everywhere âœ…
   - Same test patterns used âœ…
   - Same error handling approach

3. **Operational Consistency** âœ…
   - Single command starts everything âœ…
   - All tests run the same way âœ…
   - Deployment is unified âœ…

4. **Documentation Consistency**
   - Same README structure
   - Same docstring format
   - Same example patterns

5. **Developer Satisfaction**
   - New developers productive in < 1 hour
   - No confusion about where things go âœ…
   - Clear patterns to follow âœ…

## Part 9: Developer Tools âœ…

### Health Check Script âœ…

Add a simple script to verify the development environment:

```bash
#!/bin/bash âœ…
# scripts/healthcheck.sh âœ…

echo "ğŸ” Checking AI-DB System environment..." âœ…
echo "" âœ…

# Check Python âœ…
if command -v python3.13 &> /dev/null; then âœ…
    echo "âœ… Python 3.13 found" âœ…
else âœ…
    echo "âŒ Python 3.13 not found (required)" âœ…
    exit 1 âœ…
fi âœ…

# Check Poetry âœ…
if command -v poetry &> /dev/null; then âœ…
    echo "âœ… Poetry found" âœ…
else âœ…
    echo "âŒ Poetry not found - install with: curl -sSL https://install.python-poetry.org | python3 -" âœ…
    exit 1 âœ…
fi âœ…

# Check Docker âœ…
if command -v docker &> /dev/null; then âœ…
    echo "âœ… Docker found" âœ…
else âœ…
    echo "âŒ Docker not found (required for running the system)" âœ…
fi âœ…

# Check Git âœ…
if command -v git &> /dev/null; then âœ…
    echo "âœ… Git found" âœ…
else âœ…
    echo "âŒ Git not found (required)" âœ…
    exit 1 âœ…
fi âœ…

echo "" âœ…
echo "ğŸ‰ Environment ready for development!" âœ…
```

Make it executable: `chmod +x scripts/healthcheck.sh` âœ…

This plan transforms the fragmented codebase into a professional, maintainable system that appears to have been developed by a single, cohesive team.